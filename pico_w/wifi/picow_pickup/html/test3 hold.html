<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
</style>
</head>
<body>
  <!-- Treat each div as its own container and regardless of id name, number them increasingly.
  This the same for all input elements. -->
  <h1>The button Element</h1>

  <input type="button" id="button1" value="Click Me!">
  <input type="button" id="button2" value="Click Me!">
  <input type="button" id="button3" value="Click Me!">

  <h1>Custom Range Slider</h1>
  <p>Drag a slider to display the current value and send to the microcontroller.</p>
  
  <div id="container1">
    container1 <br>
    <input id="rangeValue1" type="range" min=0 max=100  step=10 >
    <label for="rangeValue1">_</label><br>
    
    <input id="rangeValue2" type="range" min=0 max=100  step=10 >
    <label for="rangeValue2">_</label><br>
  
    <input id="rangeValue3" type="range" min=0 max=100  step=10 >
    <label for="rangeValue3">_</label><br>
    
    <input type="radio" name="radioContainer1" id="enabled1" value=1 >
    <label for="enabled1">enabled</label><br>
    <input type="radio" name="radioContainer1" id="disabled1" value=0 >
    <label for="disabled1">disabled</label><br>
    <input type="radio" name="radioContainer1" id="locked1" value=0 >
    <label for="locked1">locked</label><br>
  
  </div>
  
  <br>
  
  <div id="container2">
    container2 <br>
    <input id="rangeValue4" type="range" min=0 max=100  step=10 >
    <label for="rangeValue4">_</label><br>
  
    <input id="rangeValue5" type="range" min=0 max=100  step=10 >
    <label for="rangeValue5">_</label><br>
  
    <input id="rangeValue6" type="range" min=0 max=100  step=10 >
    <label for="rangeValue6">_</label><br> 

    <label class="switch" for="checkboxContainer2"> 
    <input type="checkbox" id="checkboxContainer2" >
    </label>
    
  </div>

<script>
  // todo: send radio uniuqe values to microcontroller
  // add eventlistners to buttons
  const url = "http://192.168.0.188"
  const serverPort = 4242
  const pageChar = 'a' // make unique for each page

  document.addEventListener("DOMContentLoaded", function() {
    initValues();
  });

  function handleRange(event){
    const rangeInput = event.target;
    const rangeLabel = document.querySelector("label[for='" + rangeInput.id + "']");
    rangeLabel.innerHTML = rangeInput.value; // should I do this now or get a response from the microcontroller when setting value?
    // setValue(rangeInput);
  }

  function handleCheckbox(event){
    const checkboxInput = event.target;
    enablesForCheckbox(checkboxInput)
    // setValue(checkboxInput);
  }

  function handleRadio(event){
    const radioInput = event.target;
    enablesForRadio(radioInput)
    // setValue(radioInput);
  }

  function handleButton(event){
    const buttonInput = event.target;
    // setValue(buttonInput);
  }

  function enablesForRadio(radioInput){
    const parentElement = radioInput.parentElement;
    const childElements = parentElement.children;

    var disable = 0;
    var idName = radioInput.id.match(/[a-zA-Z]+/)[0];
    if(idName == "disabled" || idName == "locked"){
      disable = 1;
    }
    setRangeEnables(childElements, disable);

  }

  function enablesForCheckbox(checkboxInput){
    const parentElement = checkboxInput.parentElement.parentElement;
    const childElements = parentElement.children;

    var disable = !checkboxInput.checked

    setRangeEnables(childElements, disable);
  }

  function setRangeEnables(childElements, disable){
    for (var i = 0; i < childElements.length; i++) {
      const childElement = childElements[i]
      if(childElement.type == "range"){
        childElement.disabled = disable;        
      }
    }
  }

  async function initValues(){
      const inputElements = document.querySelectorAll('input');

      for (var i = 0; i < inputElements.length; i++) {

        const inputElement = inputElements[i];
        const inputType = inputElement.type
        const inputid = inputElement.id;
        const inputidName = inputid.match(/[a-zA-Z]+/)[0];
        const inputidNumber = parseInt(inputid.match(/\d+/)[0]);
        // add event handlers to the inputs
        switch(inputType) {
          case "range":
            inputElement.addEventListener("change", handleRange);
            break;
          case "radio":
            const name = inputElement.name.match(/[a-zA-Z]+/)[0];
              if(name == "radioContainer"){
                if(inputidName == "enabled" || inputidName == "disabled" || inputidName == "locked"){
                    inputElement.addEventListener("change", handleRadio);
                }  else {
                  console.log(" *** unknown radio inputidName : " + inputidName);
                }
              }
            break;
          case "checkbox":
            inputElement.addEventListener("change", handleCheckbox);
            break;        
          case "button":
            inputElement.addEventListener("change", handleButton);
            break;    
          default:
            console.log(" *** unknown input: " + inputElement);
        }
      }
      // get the values of the inputs from the microcontroller
      for (var i = 0; i < inputElements.length; i++) {

        const inputElement = inputElements[i];
        const inputType = inputElement.type
        const inputid = inputElement.id;
        const inputidName = inputid.match(/[a-zA-Z]+/)[0];
        const inputidNumber = parseInt(inputid.match(/\d+/)[0]);

        switch(inputType) {
          case "range":
            try {
              const valuer = await getValue(inputidNumber, 'r');
              console.log("promise value r:", valuer);
            } catch (error) {
              console.error(error);
            }
            break;
          case "radio":
            const name = inputElement.name.match(/[a-zA-Z]+/)[0];
              if(name == "radioContainer"){
                if(inputidName == "enabled" || inputidName == "disabled" || inputidName == "locked"){
                  if(inputidName == "enabled"){ // only need to check one for radio set
                      try {
                        const values = await getValue(inputidNumber, 's');
                        console.log("promise value s:", values);
                      } catch (error) {
                          console.error(error);
                      }
                  }
                }  else {
                  console.log(" *** unknown radio inputidName : " + inputidName);
                }
              }
            break;
          case "checkbox":
            try {
              const valuet = await getValue(inputidNumber, 't');
              console.log("promise value t:", valuet);
            } catch (error) {
              console.error(error);
            }
            break;          
          default:
            console.log(" *** unknown input: " + inputElement);
        }
      }
      
  }

  function getValue(elementNumber, elementTypeAbbr) {
  return new Promise(function(resolve, reject) {
    const xhr = new XMLHttpRequest();
    const arrayNumber = elementNumber - 1;
    xhr.open("POST", url + ":" + serverPort);
    xhr.setRequestHeader("Content-Type", "text/plain");

    xhr.onload = function() {
      console.log("getvalue recieved: ", pageChar, elementNumber, elementTypeAbbr, xhr.responseText);
      if (xhr.status == 200) {

        switch(elementTypeAbbr) {
          case "r":
            const rangeInput = document.getElementById("rangeValue" + elementNumber);
            const rangeLabel = document.querySelector("label[for='" + rangeInput.id + "']");
            rangeLabel.innerHTML = rangeInput.value;          
            rangeInput.value = xhr.responseText;
            rangeLabel.innerHTML = xhr.responseText;
            break;
          case "s":
            var radioInput;
            if (xhr.responseText == 0){
              radioInput = document.getElementById("disabled" + elementNumber);
              radioInput.checked = 1;
            } else if (xhr.responseText == 1){
              radioInput = document.getElementById("enabled" + elementNumber);
              radioInput.checked = 1;
            } else if (xhr.responseText == 3){
              radioInput = document.getElementById("locked" + elementNumber);
              radioInput.checked = 1;
            } else {
              console.log("unknown radio number: " + xhr.responseText);
            }
            enablesForRadio(radioInput);
            break;
          case "t":
            const checkboxInput = document.getElementById("checkboxContainer" + elementNumber);
            checkboxInput.checked = xhr.responseText == 1;
            enablesForCheckbox(checkboxInput);
            break;          
          default:
            console.log("unknown elementTypeAbbr: " + elementTypeAbbr);
        }

        resolve(xhr.responseText);
      } else {
        reject(xhr.statusText);
      }
    };

    console.log("getvalue sent: ", pageChar, elementNumber, elementTypeAbbr);
    xhr.send("getvalue" + pageChar + arrayNumber + elementTypeAbbr);
  });
}

  function setValue(inputElement) {
    var elementNumber = parseInt(inputElement.id.match(/\d+/)[0]);
    const xhr = new XMLHttpRequest();
    var elementValue = 0;
    var elementTypeAbbr = ''
    if (inputElement.type == 'range'){
      elementTypeAbbr = 'r';
      elementValue = document.getElementById(inputElement.id).value;
    } else if (inputElement.type == 'radio'){
      elementTypeAbbr = 's';
      elementValue = document.getElementById(inputElement.id).value;//******************************
    }else if (inputElement.type == 'checkbox'){
      elementTypeAbbr = 't';
      if (document.getElementById(inputElement.id).checked == true){
        elementValue = 1;
      } else {
        elementValue = 0;
      }        
    }
    console.log("setValue:", pageChar, elementNumber, elementTypeAbbr, elementValue);
    var arrayNumber = elementNumber - 1;

    xhr.open("POST", url + ":" + serverPort);
    xhr.setRequestHeader("Content-Type", "text/plain");

    xhr.onload = function() {

      if (xhr.status === 200) {
        console.log("ok response: ", xhr.responseText);
        if (xhr.responseText != elementValue){
          console.log("setValue: microcontroller responded with different sent value:", xhr.responseText);
        } 
      } else {
        console.log("Error:", xhr.status, xhr.statusText);
      }
    };

    xhr.send("setvalue" + pageChar + arrayNumber + elementTypeAbbr + elementValue);
  }

</script>

</body>
</html>